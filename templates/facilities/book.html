{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="min-h-screen bg-gray-50 dark:bg-dark py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-6xl mx-auto">

        <!-- Header -->
        <div class="mb-10 text-center">
            <h1 class="text-4xl font-extrabold text-gray-900">{{ facility.facility_name }}</h1>
            <p class="mt-2 text-lg text-gray-600">Select a date and time to book your slot.</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">

            <!-- Left: Calendar Section -->
            <div
                class="lg:col-span-2 bg-white dark:bg-slate-800 rounded-2xl shadow-xl overflow-hidden border border-gray-100 dark:border-slate-700 p-6 sticky top-6 self-start">

                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Select Date</h2>
                    <div class="flex space-x-2">
                        <button id="prevMonth" class="p-2 rounded-full hover:bg-gray-100 text-gray-600 transition">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>
                        <h3 id="currentMonthYear" class="text-xl font-semibold text-gray-700 min-w-[150px] text-center">
                        </h3>
                        <button id="nextMonth" class="p-2 rounded-full hover:bg-gray-100 text-gray-600 transition">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7">
                                </path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Calendar Grid -->
                <div class="grid grid-cols-7 gap-2 mb-2 text-center">
                    <div class="text-sm font-bold text-gray-400">Sun</div>
                    <div class="text-sm font-bold text-gray-400">Mon</div>
                    <div class="text-sm font-bold text-gray-400">Tue</div>
                    <div class="text-sm font-bold text-gray-400">Wed</div>
                    <div class="text-sm font-bold text-gray-400">Thu</div>
                    <div class="text-sm font-bold text-gray-400">Fri</div>
                    <div class="text-sm font-bold text-gray-400">Sat</div>
                </div>
                <div id="calendarGrid" class="grid grid-cols-7 gap-2 text-center">
                    <!-- Days Generated by JS -->
                </div>

                <div class="mt-6 flex flex-wrap gap-4 text-sm text-gray-600">
                    <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-green-500 mr-2"></span>
                        Available</div>
                    <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-red-500 mr-2"></span> Closed
                    </div>
                    <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-blue-600 mr-2"></span> Selected
                    </div>
                    <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-purple-500 mr-2"></span> Your
                        Booking</div>
                </div>

                <div id="bookingWarning"
                    class="hidden mt-4 p-3 bg-yellow-50 border border-yellow-200 text-yellow-800 rounded-lg text-sm">
                    <strong>Note:</strong> You already have a future booking. You cannot book another future date until
                    that one is completed.
                </div>
            </div>

            <!-- Right: Slot Selection -->
            <div
                class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-gray-100 dark:border-slate-700 p-6 flex flex-col">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6">Select Slot</h2>


                {% if not has_valid_membership %}
                <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6">
                    <p class="text-red-700">You need an active membership.</p>
                    <a href="{% url 'tariff' %}" class="text-red-800 font-bold underline mt-2 block">Buy Membership</a>
                </div>
                {% endif %}

                <div id="allClosedMessage"
                    class="hidden mb-6 p-4 bg-red-50 border border-red-200 rounded-xl text-center">
                    <p class="text-red-600 font-bold">All bookings for today are closed.</p>
                    <p class="text-sm text-red-500 mt-1">Please select a future date.</p>
                </div>

                <form method="post" id="bookingForm" class="flex-1 flex flex-col">
                    {% csrf_token %}
                    <input type="hidden" name="booking_date" id="selectedDateInput" required>

                    <div id="slotsContainer" class="space-y-4 mb-8 opacity-50 pointer-events-none transition-opacity">
                        <p id="dateDisplay" class="text-gray-500 italic mb-4">Please select a date first.</p>

                        <div id="slotList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {% for slot in slots %}
                            <label class="relative flex items-center group cursor-pointer h-full">
                                <input type="radio" name="slot" value="{{ slot.id }}" data-slot-id="{{ slot.id }}"
                                    data-start-time="{{ slot.start_time|time:'H:i' }}" class="peer sr-only" required>
                                <div
                                    class="flex-1 p-4 rounded-xl border-2 border-slate-100 peer-checked:border-blue-500 peer-checked:bg-blue-50 transition-all group-hover:border-blue-200 h-full flex flex-col justify-between">
                                    <div class="flex justify-between items-start w-full mb-2">
                                        <span class="font-bold text-gray-700 text-sm">{{ slot.session|title }}</span>
                                        <div
                                            class="w-4 h-4 rounded-full border-2 border-slate-300 peer-checked:border-blue-500 peer-checked:bg-blue-500 transition-colors shrink-0">
                                        </div>
                                    </div>
                                    <div class="w-full">
                                        <div class="text-sm text-gray-500 font-medium whitespace-nowrap">
                                            {{ slot.start_time|time:"g:i A" }} -
                                            {% if slot.display_end_time %}
                                            {{ slot.display_end_time|time:"g:i A" }}
                                            {% else %}
                                            {{ slot.end_time|time:"g:i A" }}
                                            {% endif %}
                                        </div>
                                        <div class="text-xs font-bold mt-1 slot-status text-green-600">Available
                                        </div>
                                    </div>
                                </div>
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <button type="submit" id="submitBtn" disabled
                        class="mt-auto w-full py-4 rounded-xl bg-gray-300 text-white font-bold text-lg cursor-not-allowed transition-all shadow-none">
                        Confirm Booking
                    </button>

                    {% if messages %}
                    <div class="mt-4 space-y-2">
                        {% for message in messages %}
                        <div
                            class="p-3 text-sm rounded-lg {% if message.tags == 'error' %}bg-red-100 text-red-700{% else %}bg-green-100 text-green-700{% endif %}">
                            {{ message }}
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>
</div>

{{ closures_data|json_script:"closures-data" }}
{{ user_future_dates|json_script:"future-dates-data" }}
{{ slot_availability_data|json_script:"slot-availability-data" }}
{{ facility_capacity|default:1|json_script:"facility-capacity-data" }}
{{ has_valid_membership|json_script:"membership-data" }}
{{ current_datetime|date:"U"|json_script:"current-time-data" }}

<script>
    console.log("Initializing Booking Calendar v2...");

    let closures = [];
    let userFutureDates = [];
    let slotAvailability = {};
    let facilityCapacity = 1;

    try {
        const closuresElement = document.getElementById('closures-data');
        if (closuresElement) {
            closures = JSON.parse(closuresElement.textContent);
        }

        const futureDatesElement = document.getElementById('future-dates-data');
        if (futureDatesElement) {
            userFutureDates = JSON.parse(futureDatesElement.textContent);
        }

        const slotAvailabilityElement = document.getElementById('slot-availability-data');
        if (slotAvailabilityElement) {
            slotAvailability = JSON.parse(slotAvailabilityElement.textContent);
        }

        const facilityCapacityElement = document.getElementById('facility-capacity-data');
        if (facilityCapacityElement) {
            facilityCapacity = JSON.parse(facilityCapacityElement.textContent);
        }

    } catch (e) {
        console.error("Error parsing JSON data:", e);
    }

    const today = new Date("{{ today|date:'Y-m-d' }}");
    today.setHours(0, 0, 0, 0);

    let currentYear = today.getFullYear();
    let currentMonth = today.getMonth();
    let selectedDate = null;

    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

    const calendarGrid = document.getElementById('calendarGrid');
    const displayMonth = document.getElementById('currentMonthYear');
    const dateInput = document.getElementById('selectedDateInput');
    const slotsContainer = document.getElementById('slotsContainer');
    const submitBtn = document.getElementById('submitBtn');
    const dateDisplay = document.getElementById('dateDisplay');
    const warningBox = document.getElementById('bookingWarning');
    const allClosedMessage = document.getElementById('allClosedMessage');

    function renderCalendar(year, month) {
        calendarGrid.innerHTML = '';
        displayMonth.textContent = `${monthNames[month]} ${year}`;

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // Count total slots to calculate daily capacity status
        const totalSlots = document.querySelectorAll('input[name="slot"]').length;
        const dailyMaxCapacity = totalSlots * facilityCapacity;

        for (let i = 0; i < firstDay; i++) {
            const emptyDiv = document.createElement('div');
            calendarGrid.appendChild(emptyDiv);
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const dateObj = new Date(year, month, day);
            const yearStr = dateObj.getFullYear();
            const monthStr = String(dateObj.getMonth() + 1).padStart(2, '0');
            const dayStr = String(dateObj.getDate()).padStart(2, '0');
            const dateStr = `${yearStr}-${monthStr}-${dayStr}`;

            const btn = document.createElement('button');
            btn.textContent = day;
            btn.className = "p-3 rounded-xl font-medium transition-all relative overflow-hidden focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-blue-400";

            today.setHours(0, 0, 0, 0);
            const isPast = dateObj < today;
            const isToday = dateObj.getTime() === today.getTime();
            const isClosed = closures.find(c => c.date === dateStr);
            const isUserBooking = userFutureDates.includes(dateStr);

            const bookingsForDate = slotAvailability[dateStr] || {};
            let totalBookedStart = 0;
            Object.values(bookingsForDate).forEach(count => totalBookedStart += count);
            const isFullDay = totalBookedStart >= dailyMaxCapacity;

            let disabled = false;

            if (isPast) {
                btn.classList.add('text-gray-300', 'dark:text-slate-600', 'cursor-not-allowed', 'bg-gray-50', 'dark:bg-slate-800');
                disabled = true;
            } else if (isClosed) {
                btn.classList.add('bg-red-50', 'dark:bg-red-900/30', 'text-red-500', 'dark:text-red-400', 'cursor-not-allowed', 'border', 'border-red-100', 'dark:border-red-800');
                btn.title = `Closed: ${isClosed.desc}`;
                disabled = true;
            } else if (isUserBooking) {
                btn.classList.add('bg-purple-100', 'dark:bg-purple-900/30', 'text-purple-700', 'dark:text-purple-300', 'border', 'border-purple-200', 'dark:border-purple-700');
                btn.textContent = `${day} âœ“`;
            } else {
                if (isFullDay) {
                    btn.classList.add('bg-red-50', 'dark:bg-red-900/20', 'text-red-500', 'dark:text-red-400', 'border', 'border-red-100', 'dark:border-red-800');
                    btn.title = "Fully Booked";
                } else {
                    btn.classList.add('hover:bg-green-50', 'dark:hover:bg-green-900/30', 'text-gray-700', 'dark:text-slate-300', 'bg-white', 'dark:bg-slate-700', 'border', 'border-gray-100', 'dark:border-slate-600', 'hover:border-green-300', 'dark:hover:border-green-600', 'hover:text-green-700', 'dark:hover:text-green-300');
                    btn.classList.add('text-green-600', 'dark:text-green-400', 'font-bold');
                }

                const distinctFutureDays = [...new Set(userFutureDates)];
                const otherFutureBookings = distinctFutureDays.filter(d => d !== dateStr);

                if (otherFutureBookings.length > 0 && !isToday) {
                    btn.classList.remove('text-green-600', 'font-bold', 'hover:border-green-300');
                    btn.classList.add('text-gray-400', 'cursor-not-allowed', 'bg-gray-50');
                    disabled = true;
                    btn.title = "You have a booking on another future date.";
                }
            }

            if (selectedDate === dateStr) {
                btn.classList.remove('bg-white', 'text-gray-700', 'hover:bg-green-50', 'bg-purple-100', 'text-green-600');
                btn.classList.add('bg-blue-600', 'text-white', 'shadow-lg', 'shadow-blue-500/30', 'scale-105');
            }

            if (!disabled || (isUserBooking && userFutureDates.includes(dateStr))) {
                btn.onclick = (e) => {
                    e.preventDefault();
                    if (disabled && !isUserBooking) return;
                    selectDate(dateStr, btn);
                };
            } else {
                btn.disabled = true;
            }

            calendarGrid.appendChild(btn);
        }
    }

    function selectDate(dateStr, btnElement) {
        selectedDate = dateStr;
        dateInput.value = dateStr;
        renderCalendar(currentYear, currentMonth);

        slotsContainer.classList.remove('opacity-50', 'pointer-events-none');
        slotsContainer.classList.add('opacity-100');
        dateDisplay.textContent = `Selected Date: ${new Date(dateStr).toDateString()}`;

        updateSlotAvailability(dateStr);
        updateSubmit(false);
        document.querySelectorAll('input[name="slot"]').forEach(el => el.checked = false);
    }

    function updateSlotAvailability(dateStr) {
        const slotList = document.getElementById('slotList');
        const labels = Array.from(slotList.querySelectorAll('label'));
        const bookingsForDate = slotAvailability[dateStr] || {};

        const currentTimeElement = document.getElementById('current-time-data');
        // Parse JSON content which includes quotes
        let serverNowTimestamp = Date.now();
        if (currentTimeElement) {
            try {
                const raw = JSON.parse(currentTimeElement.textContent);
                serverNowTimestamp = parseInt(raw) * 1000;
            } catch (e) { console.error("Time parse error", e); }
        }
        const serverNow = new Date(serverNowTimestamp);

        // Robust Date Comparison (String vs String)
        const serverDateStr = serverNow.getFullYear() + '-' + String(serverNow.getMonth() + 1).padStart(2, '0') + '-' + String(serverNow.getDate()).padStart(2, '0');
        const isToday = (dateStr === serverDateStr);


        console.log("Date Check:", dateStr, "ServerDate:", serverDateStr, "IsToday:", isToday);

        let availableCount = 0;

        labels.forEach(label => {
            const input = label.querySelector('input');
            const slotId = input.getAttribute('data-slot-id');
            const startTimeStr = input.getAttribute('data-start-time');
            const statusDiv = label.querySelector('.slot-status');
            const bookedCount = bookingsForDate[slotId] || 0;
            const remaining = facilityCapacity - bookedCount;

            let isExpired = false;
            // Robust Time Comparison
            if (isToday && startTimeStr) {
                const [hours, minutes] = startTimeStr.split(':').map(Number);
                const slotTime = new Date(serverNow);
                slotTime.setHours(hours, minutes, 0, 0);

                // Compare times ONLY (since date is confirmed Today)
                if (slotTime < serverNow) {
                    isExpired = true;
                }

            }

            // Clean classes
            input.disabled = false;
            label.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-50', 'bg-gray-100', 'order-1', 'order-2', 'order-3', 'hidden');
            label.querySelector('div').classList.remove('bg-gray-100');
            label.style.order = "";

            let sortOrder = 0;

            if (isExpired) {
                sortOrder = 2;
                input.disabled = true;
                label.classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-50');
                // Dim inner div too
                label.querySelector('div').classList.add('bg-gray-100');
                statusDiv.textContent = 'Expired';
                statusDiv.className = 'text-xs font-bold mt-1 slot-status text-gray-400';
            } else if (remaining <= 0) {
                sortOrder = 1;
                input.disabled = true;
                label.classList.add('opacity-60', 'cursor-not-allowed');
                statusDiv.textContent = 'Full';
                statusDiv.className = 'text-xs font-bold mt-1 slot-status text-red-500';
            } else {
                sortOrder = 0;
                availableCount++;
                statusDiv.textContent = `${remaining} spots left`;
                if (remaining <= 2) {
                    statusDiv.className = 'text-xs font-bold mt-1 slot-status text-orange-500';
                } else {
                    statusDiv.className = 'text-xs font-bold mt-1 slot-status text-green-600';
                }
            }

            label.dataset.sortStatus = sortOrder;
            label.dataset.startTime = startTimeStr;
        });

        labels.sort((a, b) => {
            const statusA = parseInt(a.dataset.sortStatus);
            const statusB = parseInt(b.dataset.sortStatus);
            if (statusA !== statusB) {
                return statusA - statusB;
            }
            return a.dataset.startTime.localeCompare(b.dataset.startTime);
        });

        labels.forEach(label => slotList.appendChild(label));

        // "All Closed" Message Logic
        if (availableCount === 0 && isToday) {
            allClosedMessage.classList.remove('hidden');
            slotsContainer.classList.add('hidden'); // Hide slots if all closed? Or show gray list?
            // User requested: "show all bookings for today are closed".
            // Showing expired list is useful context.
            // I'll keep list visible but maybe collapsed or dimmer? 
            // Or just show message above.
            slotsContainer.classList.remove('hidden'); // Ensure visible
        } else {
            allClosedMessage.classList.add('hidden');
            slotsContainer.classList.remove('hidden');
        }
    }

    function updateSubmit(hasSlot) {
        let hasMembership = false;
        const membershipElement = document.getElementById('membership-data');
        if (membershipElement) {
            hasMembership = JSON.parse(membershipElement.textContent);
        }

        if (hasSlot && hasMembership) {
            submitBtn.disabled = false;
            submitBtn.classList.remove('bg-gray-300', 'cursor-not-allowed');
            submitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700', 'shadow-lg', 'shadow-blue-500/30');
        } else {
            submitBtn.disabled = true;
            submitBtn.classList.add('bg-gray-300', 'cursor-not-allowed');
            submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'shadow-lg', 'shadow-blue-500/30');
        }
    }

    document.getElementById('prevMonth').onclick = (e) => {
        e.preventDefault();
        currentMonth--;
        if (currentMonth < 0) { currentMonth = 11; currentYear--; }
        renderCalendar(currentYear, currentMonth);
    };

    document.getElementById('nextMonth').onclick = (e) => {
        e.preventDefault();
        currentMonth++;
        if (currentMonth > 11) { currentMonth = 0; currentYear++; }
        renderCalendar(currentYear, currentMonth);
    };

    const slotInputs = document.querySelectorAll('input[name="slot"]');
    slotInputs.forEach(input => {
        input.addEventListener('change', () => updateSubmit(true));
    });

    renderCalendar(currentYear, currentMonth);
</script>
{% endblock %}